From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Nathan Skrzypczak <nathan.skrzypczak@gmail.com>
Date: Fri, 7 Apr 2023 16:57:30 +0200
Subject: [PATCH 2/4] cnat: [WIP] no k8s maglev from pods

Change-Id: Id262a97986b6de01a42019287377486787f2e606
Signed-off-by: Nathan Skrzypczak <nathan.skrzypczak@gmail.com>
---
 src/plugins/cnat/cnat_node_feature.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/src/plugins/cnat/cnat_node_feature.c b/src/plugins/cnat/cnat_node_feature.c
index f6d4850f8..f2b65b2ff 100644
--- a/src/plugins/cnat/cnat_node_feature.c
+++ b/src/plugins/cnat/cnat_node_feature.c
@@ -112,7 +112,10 @@ cnat_input_feature_new_flow_inline (vlib_main_t *vm, vlib_buffer_t *b,
 	    clib_host_to_net_u16 (trk0->ct_ep[VLIB_TX].ce_port) :
 	    rw->tuple.port[VLIB_TX];
 
-  if (trk0->ct_flags & CNAT_TRK_FLAG_NO_NAT)
+  u32 in_if = vnet_buffer (b)->sw_if_index[VLIB_RX];
+  int ispod = clib_bitmap_get (
+    cnat_snat_policy_main.interface_maps[CNAT_SNAT_IF_MAP_INCLUDE_POD], in_if);
+  if (trk0->ct_flags & CNAT_TRK_FLAG_NO_NAT && !ispod)
     {
       const dpo_id_t *dpo0;
       const load_balance_t *lb1;
-- 
2.39.2

