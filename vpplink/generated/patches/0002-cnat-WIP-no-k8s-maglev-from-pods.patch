From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: hedi bouattour <hedibouattour2010@gmail.com>
Date: Mon, 9 Feb 2026 16:38:18 +0000
Subject: [PATCH 2/3] cnat: [WIP] no k8s maglev from pods

Type: improvement

Change-Id: I2012b17d7433c9e4da79df91d00fa0adfec223d7
Signed-off-by: hedi bouattour <hedibouattour2010@gmail.com>
---
 src/plugins/cnat/cnat_node_feature.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/plugins/cnat/cnat_node_feature.c b/src/plugins/cnat/cnat_node_feature.c
index b327f2c34..380d32aec 100644
--- a/src/plugins/cnat/cnat_node_feature.c
+++ b/src/plugins/cnat/cnat_node_feature.c
@@ -32,6 +32,7 @@ cnat_input_feature_new_flow_inline (vlib_main_t *vm, vlib_buffer_t *b, ip_addres
 				    cnat_timestamp_t *ts)
 {
   vlib_combined_counter_main_t *cntm = &cnat_translation_counters;
+  cnat_snat_policy_entry_t *cpe = cnat_snat_policy_entry_get_default ();
   cnat_main_t *cm = &cnat_main;
   const cnat_translation_t *ct = NULL;
   cnat_timestamp_rewrite_t *rw = NULL;
@@ -45,6 +46,8 @@ cnat_input_feature_new_flow_inline (vlib_main_t *vm, vlib_buffer_t *b, ip_addres
   udp_header_t *udp0;
   index_t cti;
 
+  u32 in_if = vnet_buffer (b)->sw_if_index[VLIB_RX];
+  int ispod = 0;
   if (AF_IP4 == af)
     {
       ip4 = vlib_buffer_get_current (b);
@@ -98,7 +101,10 @@ cnat_input_feature_new_flow_inline (vlib_main_t *vm, vlib_buffer_t *b, ip_addres
 			      rw->tuple.port[VLIB_TX];
 
   ts->trk = trk0_i;
-  if (trk0->ct_flags & CNAT_TRK_FLAG_NO_NAT)
+  if (cpe)
+    ispod = clib_bitmap_get (cpe->interface_maps[CNAT_SNAT_IF_MAP_INCLUDE_POD],
+			     in_if);
+  if (trk0->ct_flags & CNAT_TRK_FLAG_NO_NAT && !ispod)
     {
       const dpo_id_t *dpo0;
       const load_balance_t *lb1;
-- 
2.43.0

